- name: Install postfix to send alert emails
  dnf:
    name: postfix
    state: latest

- name: copy main.cf
  copy:
    src: files/postfix-main.cf
    dest: /etc/postfix/main.cf

- shell: credstash -r eu-west-1 get ses/smtp-password
  register: credstash_smtp_password_output

- shell: credstash -r eu-west-1 get ses/smtp-username
  register: credstash_smtp_username_output

- file:
    path: /etc/postfix/sasl_passwd
    state: touch
    owner: root
    group: root
    mode: 0600

- lineinfile:
    path: /etc/postfix/sasl_passwd
    line: '[email-smtp.eu-west-1.amazonaws.com]:587 {{ smtp_username }}:{{ smtp_password }}'

- shell: postmap hash:/etc/postfix/sasl_passwd

- name: enable and start postfix
  systemd:
    name: postfix
    state: started
    enabled: yes

- name: install dnf automatic
  dnf:
    name: dnf-automatic
    state: latest

- name: dnf-automatic
  copy:
    src: files/dnf-automatic.conf
    dest: /etc/dnf/automatic.conf
    owner: root
    group: root
    mode: 0644

- name: enable a timer for dnf-automatic
  systemd:
    name: dnf-automatic.timer
    state: started
    enabled: yes
